<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storytelling | CENTRO AI</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/static/js/scripts.js"></script>
</head>
<body>
    <!-- Contenedor Principal de la Aplicaci칩n (Sidebar + Contenido) -->
    <div class="app-container"> 
        
        <!-- ============================================== -->
        <!-- 1. SIDEBAR (MEN칔 ESTILO JULIUS AI) -->
        <!-- ============================================== -->
        <div class="nav-sidebar">
            <div class="sidebar-header">
                <h2>STORY <strong>AI</strong></h2>
                <p>Generador de Insights</p>
            </div>

            <nav class="sidebar-menu">
                <a href="#analyze-section" class="menu-item active" data-page="analyze-section">
                    <span class="icon">游늵</span> An치lisis
                </a>
                <a href="#sequence-section" class="menu-item" data-page="sequence-section">
                    <span class="icon">游꿟</span> Secuencia Nativa
                </a>
                <!-- La secci칩n de Plantillas fue eliminada -->
                <a href="#story-section" class="menu-item" data-page="story-section">
                    <span class="icon">游</span> Historia/Gr치ficos IA
                </a>
                <hr>
                <a href="/logout" class="menu-item logout">
                    <span class="icon">俱뫮잺</span> Cerrar Sesi칩n
                </a>
            </nav>
            <div class="sidebar-footer">
                <!-- Se ha movido el bot칩n de descarga a la secci칩n de Historia/Gr치ficos IA -->
            </div>
        </div>

        <!-- ============================================== -->
        <!-- 2. CONTENIDO PRINCIPAL (Main Content) -->
        <!-- ============================================== -->
        <div class="main-content">
            <!-- 1. Seccion ANALIZAR CSV -->
            <div class="container active-page" id="analyze-section">
                <h1>游늵 An치lisis R치pido y Detecci칩n de Anomal칤as</h1>
                <p>Sube tu CSV y configura los par치metros que se usar치n en todas las dem치s secciones.</p>

                <form id="uploadForm">
                    <label for="file">Sube tu CSV</label>
                    <input type="file" id="file" accept=".csv" required>

                    <div class="row">
                        <div class="col">
                            <label>M칠todo por grupo</label>
                            <select id="method">
                                <option value="iqr" selected>IQR</option>
                                <option value="z">Z-score</option>
                                <option value="mad">MAD</option>
                            </select>
                        </div>
                        <div class="col">
                            <label>Agrupar por</label>
                            <select id="group_col">
                                <option value="estructuraalumno" selected>estructuraalumno</option>
                                <option value="semestre">semestre</option>
                            </select>
                        </div>
                        <div class="col">
                            <label>M칠trica</label>
                            <select id="metric_choice">
                                <option value="__tasa__" selected>__tasa__</option>
                            </select>
                        </div>
                    </div>

                    <div class="accordion">
                        <div class="accordion-header" onclick="toggleAccordion('params')">Par치metros avanzados</div>
                        <div class="accordion-content" id="params">
                            <div class="row">
                                <div class="col"><label>k (IQR)</label><input type="range" id="k_iqr" min="0.5" max="3.0" step="0.1" value="1.5"></div>
                                <div class="col"><label>Z-threshold</label><input type="range" id="z_thr" min="1.5" max="4.0" step="0.1" value="2.5"></div>
                                <div class="col"><label>MAD-threshold</label><input type="range" id="mad_thr" min="2.0" max="6.0" step="0.1" value="3.5"></div>
                                <div class="col"><label>M칤nimo n por grupo</label><input type="range" id="min_n" min="5" max="200" step="5" value="30"></div>
                                <div class="col"><label>IsolationForest (fracci칩n)</label><input type="range" id="iso_frac" min="0.0" max="0.10" step="0.005" value="0.02"></div>
                            </div>
                        </div>
                    </div>

                    <button type="button" id="analyzeBtn">Analizar CSV</button>

                <hr>

                <h3>1) Vista r치pida del dataset (Head y Esquema)</h3>
                <div id="headTable" class="table-container"></div>
                <div id="schemaTable" class="table-container"></div>

                <h3>2) Anomal칤as detectadas</h3>
                <div id="anomTable" class="table-container"></div>
                <div id="isoTable" class="table-container"></div>
            </div>

            <!-- 2. Seccion SECUENCIA NATIVA -->
            <div class="container page-content" id="sequence-section">
                <h1>游꿟 Generar Secuencia Nativa (6 pasos)</h1>
                <p>Genera la secuencia completa de 6 gr치ficos que cuentan una historia sobre la m칠trica y los grupos seleccionados.</p>

                <div class="row">
                    <div class="col">
                        <label>Tema visual</label>
                        <select id="seq_theme">
                            <option value="light" selected>Light (Fondo Blanco)</option>
                            <option value="black-orange">Negro y Naranja</option>
                            <option value="midnight">Midnight</option>
                            <option value="teal-dark">Teal Dark</option>
                            <option value="indigo">Indigo</option>
                        </select>
                    </div>
                    <div class="col">
                        <label><input type="checkbox" id="seq_simple" checked> Modo 'ni침o de 5 a침os'</label>
                    </div>
                    <div class="col">
                        <label>Top N</label>
                        <input type="range" id="seq_topn" min="3" max="20" value="8">
                    </div>
                    <div class="col">
                        <label><input type="checkbox" id="seq_norm"> Normalizar a %</label>
                    </div>
                </div>

                <div class="row">
                    <div class="col"><label>L칤neas 췅 Eje X</label><input type="text" id="seq_line_x" value="semestre"></div>
                    <div class="col"><label>L칤neas 췅 Eje Y</label><input type="text" id="seq_line_y" value="__tasa__"></div>
                    <div class="col"><label>Heatmap 췅 Fila</label><input type="text" id="seq_hm_row" value="estructuraalumno"></div>
                    <div class="col"><label>Heatmap 췅 Columna</label><input type="text" id="seq_hm_col" value="semestre"></div>
                </div>
                <div class="row">
                    <div class="col"><label>T칤tulo principal</label><input type="text" id="seq_title" value="Rendimiento Acad칠mico"></div>
                    <div class="col"><label>Subt칤tulo</slabel><input type="text" id="seq_subt" value="Secuencia de comprensi칩n visual"></div>
                </div>
                <button type="button" id="generateSeqBtn">Generar Secuencia Nativa</button>
                <div id="seqGallery"></div>
                <div id="seqLog" class="markdown"></div>
            </div>

            <!-- 3. Seccion HISTORIA NARRATIVA (IA) Y GR츼FICOS RECOMENDADOS -->
            <div class="container page-content" id="story-section">
                <h1>游 Historia Narrativa & Visualizaciones Recomendadas</h1>
                <p>Genera el resumen ejecutivo con IA (columna izquierda) y las visualizaciones de soporte autom치ticas (columna derecha).</p>
                <button type="button" id="generateStoryBtn">Generar Insights y Gr치ficos</button>
                
                <hr>
                <div class="row story-layout">
                    <!-- Panel Izquierdo: Historia de la IA -->
                    <div class="col story-col">
                        <h2>Texto Narrativo</h2>
                        <div id="storyMd" class="markdown"></div>
                    </div>

                    <!-- Panel Derecho: Gr치ficos de Soporte por IA -->
                    <div class="col charts-col">
                        <h2>Visualizaci칩n de Soporte</h2>
                        <a href="/download_zip" id="downloadZipBtn" class="download-btn-story" style="display: none; margin-bottom: 20px;">
                            拘勇 Descargar todas las infograf칤as (ZIP)
                        </a>
                        <div id="aiChartsLog" class="markdown"></div>
                        <div id="aiChartsGallery">
                            <p>(Los gr치ficos se mostrar치n aqu칤 despu칠s de generar los Insights).</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 4. Seccion PLANTILLAS INDIVIDUALES (REMOVIDA/OCULTA) -->
            <div class="container page-content" id="templates-section" style="display: none;">
                <h1>游꿛 Plantillas Individuales (Removida)</h1>
                <p>Esta secci칩n ha sido reemplazada por la funci칩n "Visualizaciones de Soporte" en la pesta침a "Historia/Gr치ficos IA".</p>
            </div>
            
        </div>
    </div>

    <!-- Lightbox (Modal) para im치genes -->
    <div id="lightboxOverlay">
        <span id="lightboxClose">&times;</span>
        <div id="lightboxContent">
            <img id="lightboxImage" src="" alt="Vista ampliada">
            <div id="lightboxCaption"></div>
        </div>
    </div>
    
</body>
</html>